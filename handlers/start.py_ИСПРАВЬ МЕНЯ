import os
from aiogram import Router, F
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton, WebAppInfo
from aiogram.filters import Command, CommandStart
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
import structlog
from database.connection import db_manager
from database.models import User, UserStatus
from database.repositories.user_repository import UserRepository
from security.encryption_manager import encryption_manager
from locales.messages import get_text, get_user_lang

logger, router = structlog.get_logger(__name__), Router(name="start")

class RegistrationStates(StatesGroup):
    choosing_language, setting_pin, confirming_pin = State(), State(), State()

def get_main_menu_keyboard(lang: str = "en") -> InlineKeyboardMarkup:
    web_app_url = os.getenv("WEB_APP_URL", "https://yourapp.onrender.com")
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üöÄ OPEN WEB WALLET", web_app=WebAppInfo(url=web_app_url))],
        [InlineKeyboardButton(text=get_text("btn_wallet", lang), callback_data="wallet"), InlineKeyboardButton(text=get_text("btn_send", lang), callback_data="send")],
        [InlineKeyboardButton(text=get_text("btn_receive", lang), callback_data="receive_menu"), InlineKeyboardButton(text=get_text("btn_swap", lang), callback_data="swap")],
        [InlineKeyboardButton(text=get_text("btn_p2p", lang), callback_data="p2p"), InlineKeyboardButton(text=get_text("btn_history", lang), callback_data="history")],
        [InlineKeyboardButton(text=get_text("btn_settings", lang), callback_data="settings"), InlineKeyboardButton(text=get_text("btn_help", lang), callback_data="help")]
    ])

@router.message(CommandStart())
async def cmd_start(message: Message, state: FSMContext):
    async with db_manager.session() as session:
        user = await UserRepository().get_by_telegram_id(session, message.from_user.id)
        if user: await show_main_menu(message, user, user.language_code)
        else:
            await message.answer(get_text("welcome", "en"), reply_markup=InlineKeyboardMarkup(inline_keyboard=[[InlineKeyboardButton(text="üá∫üá∏ English", callback_data="lang:en"), InlineKeyboardButton(text="üá∑üá∫ –†—É—Å—Å–∫–∏–π", callback_data="lang:ru")]]), parse_mode="HTML")
            await state.set_state(RegistrationStates.choosing_language)

async def show_main_menu(message: Message, user: User, lang: str, edit: bool = False):
    text = get_text("main_menu", lang, name=user.first_name or user.username)
    keyboard = get_main_menu_keyboard(lang)
    if edit: await message.edit_text(text, reply_markup=keyboard, parse_mode="HTML")
    else: await message.answer(text, reply_markup=keyboard, parse_mode="HTML")

# ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)